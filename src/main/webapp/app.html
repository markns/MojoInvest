<!doctype html>
<html>
<head>
    <title>App</title>
    <meta charset="utf-8">
    <link href="css/mojo.css" rel="stylesheet" type="text/css"/>
    <link href="css/smoothness/jquery-ui-1.8.20.custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="back">

    <div id="head">
        <div class="main">
            <a class="left" href=""><img src="../images/mojo_logo.png" alt="Mojoinvest"/></a>
            <ul id="menu">
                <li><a href="">Home</a></li>
                <li><a href="app">App</a></li>
                <li><a href="">Tools</a></li>
                <li><a href="">Help</a></li>
            </ul>
        </div>
        <div class="clear"></div>
    </div>

    <div id="content" class="main">
        <div id="params"></div>
        <div id="universe">

            <label id=""></label>

        </div>
        <div id="funds"></div>
    </div>

    <div id="footer">
        <div class="main">
            <ul class="left">
                <li><a href="About/index.html">About</a></li>
                <li><a href="Help/index.html">Help</a></li>
                <li><a href="Terms/index.html">Terms</a></li>
            </ul>
                <span class="right">
                    &copy; 2012 Mojoinvest Ltd.
                </span>

            <div class="clear"></div>
        </div>
    </div>
</div>

<script src="lib/jquery-1.7.2.min.js"></script>
<script src="lib/jquery-ui-1.8.20.custom.min.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/backbone.js"></script>
<script src="lib/backbone-relational.js"></script>
<script src="lib/ICanHaz.js"></script>

<script>

//JQuery set up stuff - where should this live?
(function ($) {
    $.fn.toggleDisabled = function () {
        return this.each(function () {
            this.disabled = !this.disabled;
        });
    };
})(jQuery);
$.datepicker.setDefaults({
    dateFormat:"yy-mm-dd"
});


tpl = {

    // Recursively pre-load all the templates for the app.
    // This implementation should be changed in a production environment. All the template files should be
    // concatenated in a single file.
    loadTemplates:function (names, callback) {

        var loadTemplate = function (index) {
            var name = names[index];
            console.log('Loading template: ' + name);
            $.get('mustache/' + name + '.mustache', function (data) {
                ich.addTemplate(name, data);
                index++;
                if (index < names.length) {
                    loadTemplate(index);
                } else {
                    callback();
                }
            }, "html");
        };

        loadTemplate(0);
    },

    // Get template by name from hash of preloaded templates
    get:function (name) {
        return this.templates[name];
    }

};

window.Params = Backbone.RelationalModel.extend({
    relations:[
        {type:Backbone.HasOne, key:'backtestParams', relatedModel:'BacktestParams'},
        {type:Backbone.HasOne, key:'strategyParams', relatedModel:'StrategyParams'},
        {type:Backbone.HasOne, key:'portfolioParams', relatedModel:'PortfolioParams'}
    ]
});
window.BacktestParams = Backbone.RelationalModel.extend({});
window.StrategyParams = Backbone.RelationalModel.extend({});
window.PortfolioParams = Backbone.RelationalModel.extend({});

window.Fund = Backbone.Model.extend({

});
var Funds = Backbone.Collection.extend({
    model:Fund
});
var AppModel = Backbone.Model.extend({
    initialize:function () {
    }
});

window.ParamsView = Backbone.View.extend({

    initialize:function () {
        this.model.get("portfolioParams").bind("change", this.render, this);
        this.model.get("strategyParams").bind("change", this.render, this);
        this.model.get("backtestParams").bind("change", this.render, this);
        this.model.bind("destroy", this.close, this);
    },

    render:function () {
        $(this.el).html(ich.params(this.model.toJSON({})));
        this.$("#fromDate").datepicker();
        this.$("#toDate").datepicker();
        this.$("#ma1").val(this.model.get("strategyParams").ma1);
        this.$("#ma2").val(this.model.get("strategyParams").ma2);
        this.$("#roc").val(this.model.get("strategyParams").roc);
        this.$("#alpha").val(this.model.get("strategyParams").alpha);
        return this;
    },

    events:{
        "click input[name='rsRadio']:radio":"rsRadioClicked",
        "click #mybutt":"buttClicked"
    },

    rsRadioClicked:function (e) {
        // find out which radio button was clicked and
        // disable/enable appropriate input elements
        switch (e.currentTarget.id) {
            case "maRatioRadio" :
                this.$('#ma1').attr('disabled', false);
                this.$('#ma2').attr('disabled', false);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', true);
                break;
            case "rocRadio" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', false);
                this.$('#alpha').attr('disabled', true);
                break;
            case "alphaRadio" :
                this.$('#ma1').attr('disabled', true);
                this.$('#ma2').attr('disabled', true);
                this.$('#roc').attr('disabled', true);
                this.$('#alpha').attr('disabled', false);
                break;
        }

    },

    buttClicked:function (e) {
//        this.model.get("strategyParams").set("portfolioSize", 2);
        console.log("Params", this.model.toJSON({}));
    }

});

window.UniverseView = Backbone.View.extend({
    initialize:function () {
        this.model.bind("change:universe", this.render, this);
    },

    render:function () {
        $(this.el).html(ich.universe(this.model.toJSON({})));
        return this;
    }

});

window.FundsView = Backbone.View.extend({
    initialize:function () {
    },

    render:function () {
        //Todo: figure out why I have to wrap the funds in another object,
        // even though when passing model they should be referenceable as #funds
        $(this.el).html(ich.funds({funds:this.model.funds.toJSON({})}));

        var universe = this.model.params.get("universe");
        this.$("input[name='includeFundCheck']:checkbox").each(function (index) {
            if ($.inArray($(this).val(), universe) != -1) {
                $(this).attr("checked", true);
            }
        });

        return this;
    },

    events:{
        "click input[name='includeFundCheck']:checkbox":"includeFundClicked"
    },

    includeFundClicked:function (e) {
        var fund = e.currentTarget.value;
        var universe = this.model.params.get("universe");
        var index = $.inArray(fund, universe);
        if (index == -1) {
            universe.push(fund);
        } else {
            universe.splice(index, 1);
        }
        //Trigger a change event on the universe view
        this.model.params.trigger('change:universe');
    }
});

Backbone.View.prototype.close = function () {
    console.log('Closing view ' + this);
    if (this.beforeClose) {
        this.beforeClose();
    }
    this.remove();
    this.unbind();
};

var AppRouter = Backbone.Router.extend({

    initialize:function (model) {
        console.log("initializing AppRouter");
//            this.model = model;
        this.paramsView = new ParamsView({model:model.params});
        this.universeView = new UniverseView({model:model.params});
        this.fundsView = new FundsView({model:model});
        $('#params').html(this.paramsView.render().el);
        $('#universe').html(this.universeView.render().el);
        $('#funds').html(this.fundsView.render().el);
    },

    routes:{
//            "":"params",
        "results":"results"
    },

    params:function () {
    },

    results:function () {
    }

});


</script>

<script>
    bootstrap = {
        load:function () {
            console.log("bootstrapping models");

            var model = new AppModel();

            model.params = new Params({"universe":["EIRL"],
                "backtestParams":{"fromDate":"1990-01-01", "toDate":"2012-03-01"},
                "strategyParams":{"portfolioSize":1, "rebalanceFrequency":1, "ma1":12, "ma2":26, "roc":26, "castOff":8, "stdDev":26, "equityCurveWindow":52, "relativeStrengthStyle":"MA", "safeAsset":"IGLT", "alpha":100},
                "portfolioParams":{"transactionCost":10.0, "creationDate":"1990-01-01", "initialInvestment":10000.0}});
            console.log(model.params);
            model.funds = new Funds([
                {"name":"iShares MSCI Ireland Cppd Invstb Mkt Idx", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EIRL", "category":"Europe Stock", "inceptionDate":[2010, 5, 5], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Ireland Investable Market 25/50 Index. The fund generally invests at least 80% of assets in securities of the underlying index and in depositary receipts representing securities of the underlying index. It may invest the remainder of its assets in securities not included in its underlying index but which BFA believes to help the fund track its index, and in futures contracts, options on futures contracts, options and swaps as well as cash and cash equivalents. The fund is non-diversified."},
                {"name":"iShares MSCI Poland Investable Mkt Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EPOL", "category":"Europe Stock", "inceptionDate":[2010, 5, 25], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expense, of the MSCI Poland Investable Market Index. The fund generally invests at least 90% of assets in the securities of the underlying index and in depositary receipts representing securities of the underlying index. It will concentrate its investments (i.e., hold 25% or more of its total assets) in a particular industry or group of industries to approximately the same extent that the underlying index is concentrated. The fund is non-diversified."},
                {"name":"iShares MSCI Sweden Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWD", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Sweden Index (the \"underlying index\"). The fund generally invests at least 90% of its assets in the securities of its underlying index and in depositary receipts (\"DRs\") representing securities in its underlying index. It will at all times invest at least 80% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The underlying index consists of stocks traded primarily on the Stockholm Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI Germany Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWG", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Germany Index. The fund normally invests at least 95% of its assets in the securities of the underlying index and in depositary receipts (DRs) representing securities in the underlying index. It invests at least 80% of its assets in the securities of the underlying index or in DRs representing securities in the underlying index. The underlying index consists of stocks traded primarily on the Frankfurt Stock Exchange."},
                {"name":"iShares MSCI Italy Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWI", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Italy Index The fund generally invests at least 90% of its assets in the securities of its underlying index and in depositary receipts (\"DRs\") representing securities in its underlying index. It will at all times invest at least 80% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The fund is non-diversified."},
                {"name":"iShares MSCI Belgium Investable Mkt Idx", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWK", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Belgium Investable Market Index. The fund generally invests at least 90% of its assets in the securities of the underlying index and in depository receipts (DRs) representing securities in the underlying index. It invests at least 80% of its assets in the securities of the underlying index or in DRs representing securities in the underlying index. The underlying index consists of stocks traded primarily on the Brussels Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI Switzerland Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWL", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Switzerland Index. The fund generally invests at least 90% of its assets in the securities of its underlying index and in depositary receipts (\"DRs\") representing securities in its underlying index. It will at all times invest at least 80% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The underlying index consists of stocks traded primarily on the Zurich Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI Netherlands Invstbl Mkt Idx", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWN", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Netherlands Investable Market Index. The fund generally invests at least 90% of its assets in the securities of the underlying index and in depositary receipts (DRs) representing securities in the underlying index. It invests at least 80% of its assets in the securities of the underlying index or in DRs representing securities in the underlying index. The underlying index consists of stocks traded primarily on the Amsterdam Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI Austria Investable Mkt Idx", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWO", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Austria Investable Market Index. The fund generally invests at least 90% of its assets in the securities of the underlying index and in depositary receipts (DRs) representing securities in the underlying index. It invests at least 80% of its assets in the securities of the underlying index or in DRs representing securities in the underlying index. The underlying index consists of stocks traded primarily on the Vienna Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI Spain Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWP", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI Spain Index. The fund generally invests at least 90% of its assets in the securities of its underlying index and in depositary receipts (\"DRs\") representing securities in its underlying index. It will at all times invest at least 80% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The underlying index consists of stocks traded primarily on the Madrid Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI France Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWQ", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI France Index. The fund normally invests at least 95% of its assets in the securities of the underlying index and in depositary receipts (DRs) representing securities in the underlying index. It invests at least 80% of its assets in the securities of the underlying index or in DRs representing securities in the underlying index. The underlying index consists of stocks traded primarily on the Paris Stock Exchange."},
                {"name":"iShares MSCI United Kingdom Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EWU", "category":"Europe Stock", "inceptionDate":[1996, 3, 12], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI United Kingdom Index. The fund generally invests at least 95% of its assets in the securities of its underlying index and in depositary receipts (\"DRs\") representing securities in its underlying index. It will at all times invest at least 90% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The underlying index consists of stocks traded primarily on the London Stock Exchange. The fund is non-diversified."},
                {"name":"iShares MSCI EMU Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"EZU", "category":"Europe Stock", "inceptionDate":[2000, 7, 25], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the MSCI EMU Index. The fund normally invests at least 95% of its assets in the securities of the underlying index and in depositary receipts representing securities in the underlying index. The fund will at all times invest at least 80% of its assets in the securities of the underlying index or in DRs representing securities in its underlying index. The underlying index consists of stocks from the following 11 countries: Austria, Belgium, Finland, France, Germany, Greece, Ireland, Italy, the Netherlands, Portugal and Spain."},
                {"name":"iShares S&P Europe 350 Index", "country":"US", "index":"MSCI EAFE NR USD", "provider":"iShares", "active":true, "symbol":"IEV", "category":"Europe Stock", "inceptionDate":[2000, 7, 25], "overview":"The investment seeks investment results that correspond generally to the price and yield performance, before fees and expenses, of the S&P Europe 350 IndexTM (the ñunderlying indexî). The fund generally invests at least 90% of assets in securities of the underlying index and in depositary receipts representing securities of the underlying index. The underlying index measures the performance of the stocks of leading companies in the following countries: Austria, Belgium, Denmark, Finland, France, Germany, Greece, Ireland, Italy, Luxembourg, the Netherlands, Norway, Portugal, Spain, Sweden, Switzerland and the United Kingdom."}
            ]);

            return model;
        }
    }
    ;
</script>

<script>

    //Load templates is async because of http requests
    tpl.loadTemplates(['params', 'funds', 'universe'], function () {

        window.app = new AppRouter(bootstrap.load());
        Backbone.history.start();
    });

</script>

<!--<script src="js/utils.js"></script>-->
<!--<script src="js/models/params.js"></script>-->
<!--<script src="js/models/app.js"></script>-->
<!--<script src="js/views/paramsview.js"></script>-->
<!--<script src="js/main.js"></script>-->


</body>
</html>